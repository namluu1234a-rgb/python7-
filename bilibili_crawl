import pandas as pd
import time
import random
import os
from selenium import webdriver
from selenium.webdriver.edge.service import Service as EdgeService
from selenium.webdriver.chrome.service import Service as ChromeService
from webdriver_manager.microsoft import EdgeChromiumDriverManager
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.chrome.options import Options as ChromeOptions
from selenium.webdriver.edge.options import Options as EdgeOptions
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from bs4 import BeautifulSoup

# ===========================
# 1. ä»»åŠ¡é…ç½®
# ===========================
TASKS = {
    # ä¹é˜³ (å½“ä¸‹)
    '002242': {'name': 'ä¹é˜³è‚¡ä»½', 'keywords': ['å“ˆåŸºç±³ ä¹é˜³', 'å“ˆåŸºç±³ è±†æµ†']},
    # èµ›åŠ›æ–¯ (å†å²å¤§æ¢—)
    '601127': {'name': 'èµ›åŠ›æ–¯', 'keywords': ['é¥é¥é¢†å…ˆ', 'åä¸ºMate60', 'é—®ç•ŒM7']},
    # å°ç±³ (å†å²å¤§æ¢—)
    '01810': {'name': 'å°ç±³é›†å›¢', 'keywords': ['å°ç±³SU7', 'é›·ç¥ é›·å†›', 'å°ç±³æ±½è½¦']}
}

RAW_DIR = "./raw_data_lake"
if not os.path.exists(RAW_DIR): os.makedirs(RAW_DIR)


# ===========================
# 2. é©±åŠ¨é…ç½® (å¼ºå…¼å®¹æ€§ç‰ˆ)
# ===========================
def get_driver():
    print("ğŸš— æ­£åœ¨å°è¯•å¯åŠ¨æµè§ˆå™¨é©±åŠ¨...")

    # --- å°è¯• 1: Edge æµè§ˆå™¨ ---
    try:
        print("   -> å°è¯•å¯åŠ¨ Edge...")
        options = EdgeOptions()
        options.add_argument('--disable-gpu')
        options.add_experimental_option('excludeSwitches', ['enable-logging'])
        # ã€å…³é”®ã€‘Bç«™åçˆ¬ä¸¥ï¼Œä¸ä½¿ç”¨ headlessï¼Œå¿…é¡»å¼¹å‡ºçª—å£
        service = EdgeService(EdgeChromiumDriverManager().install())
        driver = webdriver.Edge(service=service, options=options)
        print("   âœ… Edge å¯åŠ¨æˆåŠŸï¼")
        return driver
    except Exception as e:
        print(f"   âŒ Edge å¯åŠ¨å¤±è´¥: {e}")

    # --- å°è¯• 2: Chrome æµè§ˆå™¨ ---
    try:
        print("   -> å°è¯•å¯åŠ¨ Chrome...")
        options = ChromeOptions()
        options.add_argument('--disable-gpu')
        options.add_experimental_option('excludeSwitches', ['enable-logging'])
        service = ChromeService(ChromeDriverManager().install())
        driver = webdriver.Chrome(service=service, options=options)
        print("   âœ… Chrome å¯åŠ¨æˆåŠŸï¼")
        return driver
    except Exception as e:
        print(f"   âŒ Chrome å¯åŠ¨å¤±è´¥: {e}")

    print("ğŸš« æ‰€æœ‰æµè§ˆå™¨å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Edge æˆ– Chromeã€‚")
    return None


# ===========================
# 3. æŠ“å–é€»è¾‘
# ===========================
def crawl_keyword(driver, keyword):
    print(f"\n   ğŸ” æ­£åœ¨æœç´¢: {keyword}")

    # order=click æŒ‰ç‚¹å‡»é‡æ’åºï¼ŒæŒ–æ˜å†å²çˆ†æ¬¾
    url = f"https://search.bilibili.com/all?keyword={keyword}&order=click"

    try:
        driver.get(url)

        # æ™ºèƒ½ç­‰å¾…ï¼šç­‰å¾…è§†é¢‘å¡ç‰‡åŠ è½½å‡ºæ¥ (æœ€å¤šç­‰10ç§’)
        # å¦‚æœBç«™å¼¹å‡ºéªŒè¯ç ï¼Œè¿™é‡Œä¼šç­‰å¾…ï¼Œç»™ä½ æ—¶é—´æ‰‹åŠ¨æ»‘
        print("      â³ ç­‰å¾…é¡µé¢åŠ è½½ (å¦‚æœ‰éªŒè¯ç è¯·æ‰‹åŠ¨å®Œæˆ)...")
        WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.CLASS_NAME, "bili-video-card"))
        )
    except:
        print("      âš ï¸ é¡µé¢åŠ è½½è¶…æ—¶ï¼Œå¯èƒ½æ— å†…å®¹æˆ–è¢«æ‹¦æˆª")
        return []

    data_list = []

    # æŠ“å–å‰ 3 é¡µ (Bç«™ç²¾åéƒ½åœ¨å‰å‡ é¡µ)
    for page in range(1, 4):
        # æ»šåŠ¨é¡µé¢ (Bç«™æ˜¯æ‡’åŠ è½½ï¼Œå¿…é¡»æ»šåˆ°åº•)
        print(f"      æ­£åœ¨è¯»å–ç¬¬ {page} é¡µ...")
        for _ in range(3):
            driver.execute_script("window.scrollBy(0, 1000);")
            time.sleep(1)

        soup = BeautifulSoup(driver.page_source, 'html.parser')

        # å…¼å®¹æ–°æ—§ç‰ˆBç«™ç±»å
        cards = soup.select('.bili-video-card')
        if not cards: cards = soup.select('.video-item')

        valid_count = 0
        for card in cards:
            try:
                # æ ‡é¢˜
                title_tag = card.select_one('h3') or card.select_one('.headline')
                title = title_tag.get_text(strip=True) if title_tag else ""

                # æ—¥æœŸ
                date_tag = card.select_one('.bili-video-card__info--date') or card.select_one('.time')
                date_str = date_tag.get_text(strip=True).replace('Â·', '').strip() if date_tag else ""

                # æ•°æ® (æ’­æ”¾/å¼¹å¹•)
                stats = card.select('.bili-video-card__stats--item')
                views_str = "0"
                danmaku_str = "0"
                if stats and len(stats) >= 1: views_str = stats[0].get_text(strip=True)
                if stats and len(stats) >= 2: danmaku_str = stats[1].get_text(strip=True)

                data_list.append({
                    'raw_date': date_str,
                    'title': title,
                    'raw_views': views_str,
                    'raw_danmaku': danmaku_str,
                    'keyword': keyword
                })
                valid_count += 1
            except:
                continue

        print(f"      -> æœ¬é¡µè·å– {valid_count} æ¡")

        # ç¿»é¡µé€»è¾‘ï¼šç‚¹å‡»ä¸‹ä¸€é¡µ
        try:
            next_btns = driver.find_elements(By.XPATH,
                                             "//button[contains(@class, 'vui_pagenation--btn-side') and contains(text(), 'ä¸‹ä¸€é¡µ')]")
            if next_btns:
                driver.execute_script("arguments[0].click();", next_btns[0])
                time.sleep(3)
            else:
                break
        except:
            break

    return data_list


def main():
    driver = get_driver()
    if not driver: return

    try:
        for code, task in TASKS.items():
            print(f"\n============================")
            print(f"ğŸ“º ä»»åŠ¡å¯åŠ¨: {task['name']}")
            all_data = []

            for kw in task['keywords']:
                res = crawl_keyword(driver, kw)
                all_data.extend(res)

            if all_data:
                df = pd.DataFrame(all_data)
                df = df.drop_duplicates(subset=['title'])  # å»é‡
                save_path = f"{RAW_DIR}/bili_raw_{code}.csv"
                df.to_csv(save_path, index=False, encoding='utf-8-sig')
                print(f"âœ… {task['name']} ä¿å­˜æˆåŠŸ: {save_path} (å…± {len(df)} æ¡)")
            else:
                print(f"âš ï¸ {task['name']} æœªæŠ“åˆ°æ•°æ®")

    finally:
        print("\nğŸ›‘ çˆ¬è™«ç»“æŸï¼Œå…³é—­æµè§ˆå™¨...")
        driver.quit()


if __name__ == "__main__":
    main()
