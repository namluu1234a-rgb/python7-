import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import os
from scipy.stats import pearsonr

# ===========================
# 1. å…¨å±€ç”»é£è®¾ç½® (å­¦æœ¯çº§å®¡ç¾)
# ===========================
# ä½¿ç”¨ Seaborn çš„é«˜çº§é£æ ¼
sns.set_style("whitegrid")
# å­—ä½“è®¾ç½® (Windowsè‡ªå¸¦é»‘ä½“ï¼Œè§£å†³ä¸­æ–‡ä¹±ç )
plt.rcParams['font.sans-serif'] = ['SimHei']
plt.rcParams['axes.unicode_minus'] = False
# é«˜æ¸…åˆ†è¾¨ç‡ (è®ºæ–‡/PPTä¸“ç”¨)
plt.rcParams['figure.dpi'] = 300

DATA_DIR = "./real_data"

# ä½ çš„æ¡ˆä¾‹æ¸…å•
STOCKS = {
    '601127': {'name': 'èµ›åŠ›æ–¯', 'tag': 'ä»·å€¼å…±æŒ¯ (Pos)'},
    '01810': {'name': 'å°ç±³é›†å›¢', 'tag': 'é¢†è¢–é©±åŠ¨ (Pos)'},
    '002242': {'name': 'ä¹é˜³è‚¡ä»½', 'tag': 'å™ªéŸ³å¹²æ‰° (Neg)'}
}


def load_data():
    """è¯»å–æ‰€æœ‰è‚¡ç¥¨çš„æœ€ç»ˆæ•°æ®"""
    data = {}
    corrs = []

    for code, info in STOCKS.items():
        path = f"{DATA_DIR}/final_{code}.csv"
        if os.path.exists(path):
            df = pd.read_csv(path, index_col=0, parse_dates=True)

            # è®¡ç®—ç›¸å…³æ€§
            if len(df) > 5:
                r, _ = pearsonr(df['meme_heat'], df['CAR'])
                data[code] = df
                corrs.append({
                    'name': info['name'],
                    'r': r,
                    'type': 'positive' if r > 0.5 else 'negative',
                    'code': code
                })
    return data, pd.DataFrame(corrs)


# ===========================
# å›¾è¡¨ 1: å‘æ•£å‹æ¡å½¢å›¾ (Diverging Bars)
# ç”¨äºï¼šPPT æ€»ç»“é¡µï¼Œç›´è§‚å¯¹æ¯”è°æœ‰æ•ˆã€è°æ— æ•ˆ
# ===========================
def plot_diverging_bars(corr_df):
    print("ğŸ¨ [Chart 1] æ­£åœ¨ç»˜åˆ¶ç»“è®ºå¯¹æ¯”å›¾ (Diverging Bars)...")

    if corr_df.empty: return

    # æ’åº
    df = corr_df.sort_values('r')

    plt.figure(figsize=(10, 5))

    # é¢œè‰²æ˜ å°„ï¼šæ­£ç›¸å…³ç»¿è‰²(æœ‰æ•ˆ)ï¼Œè´Ÿç›¸å…³/å¼±ç›¸å…³çº¢è‰²(æ— æ•ˆ)
    # Aè‚¡ä¹ æƒ¯ï¼šçº¢è‰²æ¶¨(å¥½)ï¼Œç»¿è‰²è·Œ(å)ã€‚ä½†åœ¨å­¦æœ¯ç›¸å…³æ€§å›¾é‡Œï¼Œé€šå¸¸ç»¿è‰²ä»£è¡¨æ­£å‘æ”¯æ’‘ï¼Œçº¢è‰²ä»£è¡¨èƒŒç¦»
    # è¿™é‡Œæˆ‘ä»¬ç”¨ï¼šçº¢è‰²=æ­£ç›¸å…³(Aè‚¡çº¢)ï¼Œç»¿è‰²=è´Ÿç›¸å…³
    colors = ['#d62728' if x > 0 else '#2ca02c' for x in df['r']]

    plt.hlines(y=df['name'], xmin=0, xmax=df['r'], color=colors, alpha=0.8, linewidth=12)

    # æ·»åŠ æ•°å€¼æ ‡ç­¾
    for x, y, tex in zip(df['r'], df['name'], df['r']):
        t_color = '#d62728' if x > 0 else '#2ca02c'
        align = 'left' if x > 0 else 'right'
        plt.text(x, y, f" {round(tex, 3)} ", horizontalalignment=align,
                 verticalalignment='center', fontdict={'color': t_color, 'size': 12, 'weight': 'bold'})

    plt.title('å®è¯ç»“æœï¼šèˆ†æƒ…å› å­å¯¹è‚¡ä»·çš„è§£é‡ŠåŠ›å¯¹æ¯” (Pearson R)', fontdict={'size': 14, 'weight': 'bold'})
    plt.grid(linestyle='--', alpha=0.5, axis='x')
    plt.xlim(-1.2, 1.2)
    plt.xlabel('ç›¸å…³ç³»æ•° (Correlation Coefficient)', fontsize=10)

    # æ·»åŠ åŒºåŸŸæ³¨é‡Š
    plt.annotate('æ— æ•ˆ/å™ªéŸ³åŒº', xy=(-0.5, 0), xytext=(-0.8, 2),
                 fontsize=10, color='green', alpha=0.7)
    plt.annotate('æœ‰æ•ˆ/å…±æŒ¯åŒº', xy=(0.5, 0), xytext=(0.5, 2),
                 fontsize=10, color='red', alpha=0.7)

    plt.tight_layout()
    plt.savefig(f"{DATA_DIR}/1_Conclusion_Diverging_Bars.png")
    print("   âœ… å·²ä¿å­˜: 1_Conclusion_Diverging_Bars.png")


# ===========================
# å›¾è¡¨ 2: å¸¦è¾¹ç¼˜åˆ†å¸ƒçš„å›å½’å›¾ (Joint Plot)
# ç”¨äºï¼šå­¦æœ¯å®è¯ï¼Œè¯æ˜å˜é‡é—´çš„ç»Ÿè®¡å…³ç³»
# ===========================
def plot_joint_regression(df, name):
    print(f"ğŸ¨ [Chart 2] æ­£åœ¨ç»˜åˆ¶å›å½’æ£€éªŒå›¾ ({name})...")

    # è®¾ç½®é¢œè‰²ä¸»é¢˜
    color = '#d62728' if name != 'ä¹é˜³è‚¡ä»½' else '#7f8c8d'

    # ç»˜åˆ¶è”åˆå›¾
    g = sns.jointplot(
        x='meme_heat',
        y='CAR',
        data=df,
        kind='reg',  # å…³é”®ï¼šå¸¦å›å½’çº¿
        truncate=False,
        color=color,
        height=7,
        scatter_kws={'alpha': 0.5, 's': 30},
        line_kws={'lw': 2}
    )

    # ä¼˜åŒ–æ ‡ç­¾
    g.set_axis_labels('èˆ†æƒ…ç´¯ç§¯å…³æ³¨åº¦ (Cumulative Attention)', 'è‚¡ä»·ç´¯è®¡è¶…é¢æ”¶ç›Š (CAR)', fontsize=10)
    g.fig.suptitle(f'<{name}> å› å­æœ‰æ•ˆæ€§å®è¯æ£€éªŒ (Regression Fit)', fontsize=14, y=1.02)

    plt.savefig(f"{DATA_DIR}/2_Regression_{name}.png", bbox_inches='tight')
    print(f"   âœ… å·²ä¿å­˜: 2_Regression_{name}.png")


# ===========================
# å›¾è¡¨ 3: åŒè½´é¢ç§¯å›¾ (Dual-Axis Area)
# ç”¨äºï¼šå±•ç¤ºâ€œæ—¶ç©ºä¼´éšâ€ç°è±¡ï¼Œæœ€ç›´è§‚çš„è¶‹åŠ¿å›¾
# ===========================
def plot_dual_axis(df, name):
    print(f"ğŸ¨ [Chart 3] æ­£åœ¨ç»˜åˆ¶æ—¶ç©ºä¼´éšå›¾ ({name})...")

    fig, ax1 = plt.subplots(figsize=(12, 5))

    # è½´1ï¼šèˆ†æƒ… (é¢ç§¯å›¾)
    color1 = '#ff7f0e'  # æ©™è‰²
    ax1.set_xlabel('äº¤æ˜“æ—¥æœŸ', fontsize=10)
    ax1.set_ylabel('èˆ†æƒ…çƒ­åº¦ç´¯ç§¯', color=color1, fontsize=10)
    # å¡«å……é¢ç§¯
    ax1.fill_between(df.index, df['meme_heat'], color=color1, alpha=0.2)
    ax1.plot(df.index, df['meme_heat'], color=color1, alpha=0.6, linewidth=1, label='èˆ†æƒ…çƒ­åº¦')
    ax1.tick_params(axis='y', labelcolor=color1)

    # è½´2ï¼šè‚¡ä»· (å®çº¿)
    ax2 = ax1.twinx()
    color2 = '#1f77b4'  # è“è‰²
    ax2.set_ylabel('è‚¡ä»·è¶…é¢æ”¶ç›Š (CAR)', color=color2, fontsize=10)
    ax2.plot(df.index, df['CAR'], color=color2, linewidth=2.5, label='è‚¡ä»·CAR')
    ax2.tick_params(axis='y', labelcolor=color2)

    # æ ‡é¢˜
    plt.title(f'<{name}>: èˆ†æƒ…å‘é…µä¸èµ„é‡‘è¡Œä¸ºçš„æ—¶ç©ºä¼´éšåˆ†æ', fontsize=14, fontweight='bold')
    plt.grid(True, alpha=0.3)

    plt.tight_layout()
    plt.savefig(f"{DATA_DIR}/3_DualAxis_{name}.png")
    print(f"   âœ… å·²ä¿å­˜: 3_DualAxis_{name}.png")


# ===========================
# å›¾è¡¨ 4: å°æç´å›¾ (Violin Plot)
# ç”¨äºï¼šå¾®è§‚å®¡è®¡ï¼Œåˆ†ææƒ…ç»ªçš„æ³¢åŠ¨ç‡å’Œåˆ†å¸ƒç‰¹å¾
# ===========================
def plot_violin(data_dict):
    print("ğŸ¨ [Chart 4] æ­£åœ¨ç»˜åˆ¶æƒ…ç»ªåˆ†å¸ƒå›¾ (Violin)...")

    # æ„é€ åˆå¹¶æ•°æ®
    combined = []
    for code, df in data_dict.items():
        temp = pd.DataFrame({
            'Stock': STOCKS[code]['name'],
            'Buzz': df['total_buzz']  # ç”¨æ¯æ—¥åŸå§‹çƒ­åº¦
        })
        combined.append(temp)

    if not combined: return
    df_all = pd.concat(combined)

    plt.figure(figsize=(10, 6))
    # ç»˜å›¾
    sns.violinplot(x='Stock', y='Buzz', data=df_all, palette="Set2", inner="box", linewidth=1.5)

    plt.title('ä¸åŒæ¡ˆä¾‹çš„èˆ†æƒ…çˆ†å‘åŠ›åˆ†å¸ƒå¯¹æ¯” (Violin Plot)', fontsize=14)
    plt.ylabel('å•æ—¥è®¨è®ºçƒ­åº¦ (Daily Buzz)', fontsize=10)
    plt.xlabel('æ ‡çš„èµ„äº§', fontsize=10)

    plt.tight_layout()
    plt.savefig(f"{DATA_DIR}/4_Violin_Distribution.png")
    print("   âœ… å·²ä¿å­˜: 4_Violin_Distribution.png")


# ===========================
# ä¸»ç¨‹åºå…¥å£
# ===========================
if __name__ == "__main__":
    # 1. åŠ è½½æ•°æ®
    data_dict, corr_df = load_data()

    if not data_dict:
        print("âŒ æ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œ processing.py ç”Ÿæˆ final_xxxx.csv")
    else:
        # 2. ç»˜åˆ¶ç»“è®ºå›¾ (å¯¹æ¯”)
        plot_diverging_bars(corr_df)

        # 3. ç»˜åˆ¶èµ›åŠ›æ–¯ (ä½œä¸ºæ­£é¢å…¸å‹ï¼šä»·å€¼å…±æŒ¯)
        if '601127' in data_dict:
            plot_joint_regression(data_dict['601127'], 'èµ›åŠ›æ–¯')
            plot_dual_axis(data_dict['601127'], 'èµ›åŠ›æ–¯')

        # 4. ç»˜åˆ¶ä¹é˜³ (ä½œä¸ºåé¢å…¸å‹ï¼šå™ªéŸ³å¹²æ‰°)
        if '002242' in data_dict:
            plot_dual_axis(data_dict['002242'], 'ä¹é˜³è‚¡ä»½')

        # 5. ç»˜åˆ¶åˆ†å¸ƒå¯¹æ¯”
        plot_violin(data_dict)

        print("\nğŸ‰ å…¨éƒ¨é«˜æ¸…å›¾è¡¨å·²ç”Ÿæˆï¼è¯·æ‰“å¼€ real_data æ–‡ä»¶å¤¹æŸ¥çœ‹ã€‚")
